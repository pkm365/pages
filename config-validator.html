<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N8N配置验证工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .check-item { transition: all 0.3s ease; }
        .check-pass { border-left: 4px solid #10b981; background-color: #d1fae5; }
        .check-fail { border-left: 4px solid #ef4444; background-color: #fee2e2; }
        .check-pending { border-left: 4px solid #f59e0b; background-color: #fef3c7; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">🔧 N8N配置验证工具</h1>
            <p class="text-gray-600">检查你的N8N工作流配置是否正确</p>
        </div>

        <!-- 配置输入区域 -->
        <div class="bg-blue-50 p-6 rounded-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">📋 配置信息</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">N8N Webhook URL</label>
                    <input type="url" id="webhookUrl" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://your-n8n.com/webhook/...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">GitHub 用户名</label>
                    <input type="text" id="githubUsername" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your-username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">GitHub 仓库名</label>
                    <input type="text" id="githubRepo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="pages">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">GitHub Token (可选)</label>
                    <input type="password" id="githubToken" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ghp_xxxxxxxxxxxx">
                </div>
            </div>
            <div class="mt-4">
                <button onclick="startValidation()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    🔍 开始验证
                </button>
                <button onclick="resetValidation()" class="ml-2 bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">
                    🔄 重置
                </button>
            </div>
        </div>

        <!-- 验证结果区域 -->
        <div id="validationResults" class="space-y-4">
            <!-- 1. URL格式检查 -->
            <div id="check-url" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-url-icon" class="mr-3">⏳</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">URL格式检查</h3>
                        <p id="check-url-desc" class="text-sm text-gray-600">检查N8N Webhook URL格式是否正确</p>
                    </div>
                    <div id="check-url-status" class="text-sm font-medium">待检查</div>
                </div>
            </div>

            <!-- 2. N8N连通性测试 -->
            <div id="check-n8n" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-n8n-icon" class="mr-3">⏳</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">N8N连通性测试</h3>
                        <p id="check-n8n-desc" class="text-sm text-gray-600">测试N8N webhook是否可以正常访问</p>
                    </div>
                    <div id="check-n8n-status" class="text-sm font-medium">待检查</div>
                </div>
            </div>

            <!-- 3. GitHub仓库检查 -->
            <div id="check-github" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-github-icon" class="mr-3">⏳</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">GitHub仓库检查</h3>
                        <p id="check-github-desc" class="text-sm text-gray-600">验证GitHub仓库是否存在且可访问</p>
                    </div>
                    <div id="check-github-status" class="text-sm font-medium">待检查</div>
                </div>
            </div>

            <!-- 4. GitHub Pages检查 -->
            <div id="check-pages" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-pages-icon" class="mr-3">⏳</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">GitHub Pages检查</h3>
                        <p id="check-pages-desc" class="text-sm text-gray-600">检查GitHub Pages是否已启用</p>
                    </div>
                    <div id="check-pages-status" class="text-sm font-medium">待检查</div>
                </div>
            </div>

            <!-- 5. 文件结构检查 -->
            <div id="check-files" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-files-icon" class="mr-3">⏳</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">文件结构检查</h3>
                        <p id="check-files-desc" class="text-sm text-gray-600">检查必要的文件是否存在</p>
                    </div>
                    <div id="check-files-status" class="text-sm font-medium">待检查</div>
                </div>
            </div>

            <!-- 6. 模拟发布测试 -->
            <div id="check-publish" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-publish-icon" class="mr-3">⏳</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">模拟发布测试</h3>
                        <p id="check-publish-desc" class="text-sm text-gray-600">执行一次完整的发布流程测试</p>
                    </div>
                    <div id="check-publish-status" class="text-sm font-medium">待检查</div>
                </div>
            </div>
        </div>

        <!-- 总体结果 -->
        <div id="overallResult" class="mt-8 p-6 rounded-lg border-2 hidden">
            <div class="text-center">
                <div id="overallIcon" class="text-6xl mb-4">⏳</div>
                <h2 id="overallTitle" class="text-2xl font-bold mb-2">验证进行中...</h2>
                <p id="overallDesc" class="text-gray-600 mb-4">正在检查你的配置...</p>
                <div id="overallActions" class="hidden space-x-4">
                    <button onclick="downloadReport()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        📄 下载报告
                    </button>
                    <button onclick="testPublish()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        🚀 测试发布
                    </button>
                </div>
            </div>
        </div>

        <!-- 帮助信息 -->
        <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h3 class="font-semibold text-yellow-800 mb-2">💡 使用提示</h3>
            <ul class="text-sm text-yellow-700 space-y-1">
                <li>• 请确保N8N工作流已经正确导入并激活</li>
                <li>• GitHub Token是可选的，但提供后可以进行更详细的检查</li>
                <li>• 模拟发布测试会创建一个测试文件，请确保这是可接受的</li>
                <li>• 如果某项检查失败，请查看详细描述中的解决建议</li>
            </ul>
        </div>
    </div>

    <script>
        let validationResults = {};
        
        async function startValidation() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            const githubUsername = document.getElementById('githubUsername').value;
            const githubRepo = document.getElementById('githubRepo').value;
            const githubToken = document.getElementById('githubToken').value;
            
            if (!webhookUrl || !githubUsername || !githubRepo) {
                alert('请填写必要的配置信息');
                return;
            }
            
            // 显示总体结果区域
            document.getElementById('overallResult').classList.remove('hidden');
            
            // 重置所有检查状态
            resetAllChecks();
            
            // 开始验证
            await validateUrl(webhookUrl);
            await validateN8NConnectivity(webhookUrl);
            await validateGitHubRepo(githubUsername, githubRepo, githubToken);
            await validateGitHubPages(githubUsername, githubRepo);
            await validateFileStructure(githubUsername, githubRepo, githubToken);
            await validatePublishFlow(webhookUrl);
            
            // 显示最终结果
            showOverallResult();
        }
        
        function resetValidation() {
            document.getElementById('overallResult').classList.add('hidden');
            resetAllChecks();
            validationResults = {};
        }
        
        function resetAllChecks() {
            const checks = ['url', 'n8n', 'github', 'pages', 'files', 'publish'];
            checks.forEach(check => {
                updateCheckStatus(check, 'pending', '⏳', '待检查');
            });
        }
        
        async function validateUrl(url) {
            try {
                const urlObj = new URL(url);
                if (urlObj.protocol !== 'https:' && urlObj.protocol !== 'http:') {
                    throw new Error('URL协议不正确');
                }
                
                updateCheckStatus('url', 'pass', '✅', '格式正确');
                validationResults.url = { success: true, message: 'URL格式正确' };
            } catch (error) {
                updateCheckStatus('url', 'fail', '❌', `格式错误: ${error.message}`);
                validationResults.url = { success: false, message: error.message };
            }
        }
        
        async function validateN8NConnectivity(url) {
            updateCheckStatus('n8n', 'pending', '🔄', '测试中...');
            
            try {
                // 尝试OPTIONS请求检查CORS
                const response = await fetch(url, {
                    method: 'OPTIONS',
                    mode: 'cors'
                });
                
                updateCheckStatus('n8n', 'pass', '✅', 'N8N服务可访问');
                validationResults.n8n = { success: true, message: 'N8N服务可访问' };
            } catch (error) {
                updateCheckStatus('n8n', 'fail', '❌', `连接失败: ${error.message}`);
                validationResults.n8n = { success: false, message: error.message };
            }
        }
        
        async function validateGitHubRepo(username, repo, token) {
            updateCheckStatus('github', 'pending', '🔄', '检查中...');
            
            try {
                const headers = token ? { 'Authorization': `token ${token}` } : {};
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
                    headers: headers
                });
                
                if (response.ok) {
                    const repoData = await response.json();
                    updateCheckStatus('github', 'pass', '✅', `仓库存在: ${repoData.full_name}`);
                    validationResults.github = { success: true, message: '仓库存在且可访问', data: repoData };
                } else if (response.status === 404) {
                    updateCheckStatus('github', 'fail', '❌', '仓库不存在或无权限访问');
                    validationResults.github = { success: false, message: '仓库不存在或无权限访问' };
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateCheckStatus('github', 'fail', '❌', `检查失败: ${error.message}`);
                validationResults.github = { success: false, message: error.message };
            }
        }
        
        async function validateGitHubPages(username, repo) {
            updateCheckStatus('pages', 'pending', '🔄', '检查中...');
            
            try {
                const pagesUrl = `https://${username}.github.io/${repo}/`;
                const response = await fetch(pagesUrl, { method: 'HEAD', mode: 'no-cors' });
                
                // 由于CORS限制，我们无法直接检查响应，但可以假设如果没有错误就是可访问的
                updateCheckStatus('pages', 'pass', '✅', 'GitHub Pages可访问');
                validationResults.pages = { success: true, message: 'GitHub Pages可访问', url: pagesUrl };
            } catch (error) {
                updateCheckStatus('pages', 'fail', '❌', `Pages检查失败: ${error.message}`);
                validationResults.pages = { success: false, message: error.message };
            }
        }
        
        async function validateFileStructure(username, repo, token) {
            updateCheckStatus('files', 'pending', '🔄', '检查中...');
            
            try {
                const headers = token ? { 'Authorization': `token ${token}` } : {};
                const requiredFiles = ['generate_nav.py', '.github/workflows/deploy.yml'];
                const results = [];
                
                for (const file of requiredFiles) {
                    try {
                        const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${file}`, {
                            headers: headers
                        });
                        results.push({ file, exists: response.ok });
                    } catch (error) {
                        results.push({ file, exists: false });
                    }
                }
                
                const existingFiles = results.filter(r => r.exists);
                const missingFiles = results.filter(r => !r.exists);
                
                if (missingFiles.length === 0) {
                    updateCheckStatus('files', 'pass', '✅', '所有必要文件都存在');
                    validationResults.files = { success: true, message: '所有必要文件都存在', results };
                } else {
                    updateCheckStatus('files', 'fail', '❌', `缺少文件: ${missingFiles.map(f => f.file).join(', ')}`);
                    validationResults.files = { success: false, message: '缺少必要文件', results };
                }
            } catch (error) {
                updateCheckStatus('files', 'fail', '❌', `文件检查失败: ${error.message}`);
                validationResults.files = { success: false, message: error.message };
            }
        }
        
        async function validatePublishFlow(webhookUrl) {
            updateCheckStatus('publish', 'pending', '🔄', '模拟发布中...');
            
            try {
                const testData = {
                    htmlContent: '<!DOCTYPE html><html><head><title>配置验证测试</title></head><body><h1>这是一个自动生成的测试页面</h1><p>用于验证N8N工作流配置。</p></body></html>',
                    fileName: 'config-validation-test.html',
                    commitMessage: '配置验证测试 - 自动生成'
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateCheckStatus('publish', 'pass', '✅', '发布测试成功');
                    validationResults.publish = { success: true, message: '发布测试成功', result };
                } else {
                    updateCheckStatus('publish', 'fail', '❌', `发布失败: ${result.error || result.message}`);
                    validationResults.publish = { success: false, message: result.error || result.message };
                }
            } catch (error) {
                updateCheckStatus('publish', 'fail', '❌', `发布测试失败: ${error.message}`);
                validationResults.publish = { success: false, message: error.message };
            }
        }
        
        function updateCheckStatus(checkType, status, icon, message) {
            const checkElement = document.getElementById(`check-${checkType}`);
            const iconElement = document.getElementById(`check-${checkType}-icon`);
            const statusElement = document.getElementById(`check-${checkType}-status`);
            
            // 更新样式
            checkElement.className = `check-item p-4 rounded-lg border check-${status}`;
            iconElement.textContent = icon;
            statusElement.textContent = message;
        }
        
        function showOverallResult() {
            const totalChecks = Object.keys(validationResults).length;
            const passedChecks = Object.values(validationResults).filter(r => r.success).length;
            const failedChecks = totalChecks - passedChecks;
            
            const overallResult = document.getElementById('overallResult');
            const overallIcon = document.getElementById('overallIcon');
            const overallTitle = document.getElementById('overallTitle');
            const overallDesc = document.getElementById('overallDesc');
            const overallActions = document.getElementById('overallActions');
            
            if (failedChecks === 0) {
                overallResult.className = 'mt-8 p-6 rounded-lg border-2 border-green-500 bg-green-50';
                overallIcon.textContent = '🎉';
                overallTitle.textContent = '配置验证通过！';
                overallDesc.textContent = '所有检查都已通过，你的N8N工作流配置正确，可以正常使用。';
            } else if (passedChecks > failedChecks) {
                overallResult.className = 'mt-8 p-6 rounded-lg border-2 border-yellow-500 bg-yellow-50';
                overallIcon.textContent = '⚠️';
                overallTitle.textContent = '配置基本正常';
                overallDesc.textContent = `${passedChecks}项检查通过，${failedChecks}项需要注意。建议修复失败项后重新测试。`;
            } else {
                overallResult.className = 'mt-8 p-6 rounded-lg border-2 border-red-500 bg-red-50';
                overallIcon.textContent = '❌';
                overallTitle.textContent = '配置存在问题';
                overallDesc.textContent = `${failedChecks}项检查失败，请根据上方提示修复后重新验证。`;
            }
            
            overallActions.classList.remove('hidden');
        }
        
        function downloadReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: Object.keys(validationResults).length,
                    passed: Object.values(validationResults).filter(r => r.success).length,
                    failed: Object.values(validationResults).filter(r => !r.success).length
                },
                details: validationResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `n8n-validation-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function testPublish() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            if (webhookUrl) {
                window.open('content-publisher-form.html', '_blank');
            } else {
                alert('请先填写并验证N8N Webhook URL');
            }
        }
    </script>
</body>
</html>