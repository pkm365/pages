<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N8Né…ç½®éªŒè¯å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .check-item { transition: all 0.3s ease; }
        .check-pass { border-left: 4px solid #10b981; background-color: #d1fae5; }
        .check-fail { border-left: 4px solid #ef4444; background-color: #fee2e2; }
        .check-pending { border-left: 4px solid #f59e0b; background-color: #fef3c7; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ”§ N8Né…ç½®éªŒè¯å·¥å…·</h1>
            <p class="text-gray-600">æ£€æŸ¥ä½ çš„N8Nå·¥ä½œæµé…ç½®æ˜¯å¦æ­£ç¡®</p>
        </div>

        <!-- é…ç½®è¾“å…¥åŒºåŸŸ -->
        <div class="bg-blue-50 p-6 rounded-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ é…ç½®ä¿¡æ¯</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">N8N Webhook URL</label>
                    <input type="url" id="webhookUrl" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://your-n8n.com/webhook/...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">GitHub ç”¨æˆ·å</label>
                    <input type="text" id="githubUsername" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your-username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">GitHub ä»“åº“å</label>
                    <input type="text" id="githubRepo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="pages">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">GitHub Token (å¯é€‰)</label>
                    <input type="password" id="githubToken" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ghp_xxxxxxxxxxxx">
                </div>
            </div>
            <div class="mt-4">
                <button onclick="startValidation()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    ğŸ” å¼€å§‹éªŒè¯
                </button>
                <button onclick="resetValidation()" class="ml-2 bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">
                    ğŸ”„ é‡ç½®
                </button>
            </div>
        </div>

        <!-- éªŒè¯ç»“æœåŒºåŸŸ -->
        <div id="validationResults" class="space-y-4">
            <!-- 1. URLæ ¼å¼æ£€æŸ¥ -->
            <div id="check-url" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-url-icon" class="mr-3">â³</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">URLæ ¼å¼æ£€æŸ¥</h3>
                        <p id="check-url-desc" class="text-sm text-gray-600">æ£€æŸ¥N8N Webhook URLæ ¼å¼æ˜¯å¦æ­£ç¡®</p>
                    </div>
                    <div id="check-url-status" class="text-sm font-medium">å¾…æ£€æŸ¥</div>
                </div>
            </div>

            <!-- 2. N8Nè¿é€šæ€§æµ‹è¯• -->
            <div id="check-n8n" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-n8n-icon" class="mr-3">â³</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">N8Nè¿é€šæ€§æµ‹è¯•</h3>
                        <p id="check-n8n-desc" class="text-sm text-gray-600">æµ‹è¯•N8N webhookæ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®</p>
                    </div>
                    <div id="check-n8n-status" class="text-sm font-medium">å¾…æ£€æŸ¥</div>
                </div>
            </div>

            <!-- 3. GitHubä»“åº“æ£€æŸ¥ -->
            <div id="check-github" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-github-icon" class="mr-3">â³</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">GitHubä»“åº“æ£€æŸ¥</h3>
                        <p id="check-github-desc" class="text-sm text-gray-600">éªŒè¯GitHubä»“åº“æ˜¯å¦å­˜åœ¨ä¸”å¯è®¿é—®</p>
                    </div>
                    <div id="check-github-status" class="text-sm font-medium">å¾…æ£€æŸ¥</div>
                </div>
            </div>

            <!-- 4. GitHub Pagesæ£€æŸ¥ -->
            <div id="check-pages" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-pages-icon" class="mr-3">â³</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">GitHub Pagesæ£€æŸ¥</h3>
                        <p id="check-pages-desc" class="text-sm text-gray-600">æ£€æŸ¥GitHub Pagesæ˜¯å¦å·²å¯ç”¨</p>
                    </div>
                    <div id="check-pages-status" class="text-sm font-medium">å¾…æ£€æŸ¥</div>
                </div>
            </div>

            <!-- 5. æ–‡ä»¶ç»“æ„æ£€æŸ¥ -->
            <div id="check-files" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-files-icon" class="mr-3">â³</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">æ–‡ä»¶ç»“æ„æ£€æŸ¥</h3>
                        <p id="check-files-desc" class="text-sm text-gray-600">æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p>
                    </div>
                    <div id="check-files-status" class="text-sm font-medium">å¾…æ£€æŸ¥</div>
                </div>
            </div>

            <!-- 6. æ¨¡æ‹Ÿå‘å¸ƒæµ‹è¯• -->
            <div id="check-publish" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-publish-icon" class="mr-3">â³</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">æ¨¡æ‹Ÿå‘å¸ƒæµ‹è¯•</h3>
                        <p id="check-publish-desc" class="text-sm text-gray-600">æ‰§è¡Œä¸€æ¬¡å®Œæ•´çš„å‘å¸ƒæµç¨‹æµ‹è¯•</p>
                    </div>
                    <div id="check-publish-status" class="text-sm font-medium">å¾…æ£€æŸ¥</div>
                </div>
            </div>
        </div>

        <!-- æ€»ä½“ç»“æœ -->
        <div id="overallResult" class="mt-8 p-6 rounded-lg border-2 hidden">
            <div class="text-center">
                <div id="overallIcon" class="text-6xl mb-4">â³</div>
                <h2 id="overallTitle" class="text-2xl font-bold mb-2">éªŒè¯è¿›è¡Œä¸­...</h2>
                <p id="overallDesc" class="text-gray-600 mb-4">æ­£åœ¨æ£€æŸ¥ä½ çš„é…ç½®...</p>
                <div id="overallActions" class="hidden space-x-4">
                    <button onclick="downloadReport()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        ğŸ“„ ä¸‹è½½æŠ¥å‘Š
                    </button>
                    <button onclick="testPublish()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        ğŸš€ æµ‹è¯•å‘å¸ƒ
                    </button>
                </div>
            </div>
        </div>

        <!-- å¸®åŠ©ä¿¡æ¯ -->
        <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h3 class="font-semibold text-yellow-800 mb-2">ğŸ’¡ ä½¿ç”¨æç¤º</h3>
            <ul class="text-sm text-yellow-700 space-y-1">
                <li>â€¢ è¯·ç¡®ä¿N8Nå·¥ä½œæµå·²ç»æ­£ç¡®å¯¼å…¥å¹¶æ¿€æ´»</li>
                <li>â€¢ GitHub Tokenæ˜¯å¯é€‰çš„ï¼Œä½†æä¾›åå¯ä»¥è¿›è¡Œæ›´è¯¦ç»†çš„æ£€æŸ¥</li>
                <li>â€¢ æ¨¡æ‹Ÿå‘å¸ƒæµ‹è¯•ä¼šåˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œè¯·ç¡®ä¿è¿™æ˜¯å¯æ¥å—çš„</li>
                <li>â€¢ å¦‚æœæŸé¡¹æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æè¿°ä¸­çš„è§£å†³å»ºè®®</li>
            </ul>
        </div>
    </div>

    <script>
        let validationResults = {};
        
        async function startValidation() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            const githubUsername = document.getElementById('githubUsername').value;
            const githubRepo = document.getElementById('githubRepo').value;
            const githubToken = document.getElementById('githubToken').value;
            
            if (!webhookUrl || !githubUsername || !githubRepo) {
                alert('è¯·å¡«å†™å¿…è¦çš„é…ç½®ä¿¡æ¯');
                return;
            }
            
            // æ˜¾ç¤ºæ€»ä½“ç»“æœåŒºåŸŸ
            document.getElementById('overallResult').classList.remove('hidden');
            
            // é‡ç½®æ‰€æœ‰æ£€æŸ¥çŠ¶æ€
            resetAllChecks();
            
            // å¼€å§‹éªŒè¯
            await validateUrl(webhookUrl);
            await validateN8NConnectivity(webhookUrl);
            await validateGitHubRepo(githubUsername, githubRepo, githubToken);
            await validateGitHubPages(githubUsername, githubRepo);
            await validateFileStructure(githubUsername, githubRepo, githubToken);
            await validatePublishFlow(webhookUrl);
            
            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            showOverallResult();
        }
        
        function resetValidation() {
            document.getElementById('overallResult').classList.add('hidden');
            resetAllChecks();
            validationResults = {};
        }
        
        function resetAllChecks() {
            const checks = ['url', 'n8n', 'github', 'pages', 'files', 'publish'];
            checks.forEach(check => {
                updateCheckStatus(check, 'pending', 'â³', 'å¾…æ£€æŸ¥');
            });
        }
        
        async function validateUrl(url) {
            try {
                const urlObj = new URL(url);
                if (urlObj.protocol !== 'https:' && urlObj.protocol !== 'http:') {
                    throw new Error('URLåè®®ä¸æ­£ç¡®');
                }
                
                updateCheckStatus('url', 'pass', 'âœ…', 'æ ¼å¼æ­£ç¡®');
                validationResults.url = { success: true, message: 'URLæ ¼å¼æ­£ç¡®' };
            } catch (error) {
                updateCheckStatus('url', 'fail', 'âŒ', `æ ¼å¼é”™è¯¯: ${error.message}`);
                validationResults.url = { success: false, message: error.message };
            }
        }
        
        async function validateN8NConnectivity(url) {
            updateCheckStatus('n8n', 'pending', 'ğŸ”„', 'æµ‹è¯•ä¸­...');
            
            try {
                // å°è¯•OPTIONSè¯·æ±‚æ£€æŸ¥CORS
                const response = await fetch(url, {
                    method: 'OPTIONS',
                    mode: 'cors'
                });
                
                updateCheckStatus('n8n', 'pass', 'âœ…', 'N8NæœåŠ¡å¯è®¿é—®');
                validationResults.n8n = { success: true, message: 'N8NæœåŠ¡å¯è®¿é—®' };
            } catch (error) {
                updateCheckStatus('n8n', 'fail', 'âŒ', `è¿æ¥å¤±è´¥: ${error.message}`);
                validationResults.n8n = { success: false, message: error.message };
            }
        }
        
        async function validateGitHubRepo(username, repo, token) {
            updateCheckStatus('github', 'pending', 'ğŸ”„', 'æ£€æŸ¥ä¸­...');
            
            try {
                const headers = token ? { 'Authorization': `token ${token}` } : {};
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
                    headers: headers
                });
                
                if (response.ok) {
                    const repoData = await response.json();
                    updateCheckStatus('github', 'pass', 'âœ…', `ä»“åº“å­˜åœ¨: ${repoData.full_name}`);
                    validationResults.github = { success: true, message: 'ä»“åº“å­˜åœ¨ä¸”å¯è®¿é—®', data: repoData };
                } else if (response.status === 404) {
                    updateCheckStatus('github', 'fail', 'âŒ', 'ä»“åº“ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®');
                    validationResults.github = { success: false, message: 'ä»“åº“ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®' };
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateCheckStatus('github', 'fail', 'âŒ', `æ£€æŸ¥å¤±è´¥: ${error.message}`);
                validationResults.github = { success: false, message: error.message };
            }
        }
        
        async function validateGitHubPages(username, repo) {
            updateCheckStatus('pages', 'pending', 'ğŸ”„', 'æ£€æŸ¥ä¸­...');
            
            try {
                const pagesUrl = `https://${username}.github.io/${repo}/`;
                const response = await fetch(pagesUrl, { method: 'HEAD', mode: 'no-cors' });
                
                // ç”±äºCORSé™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥æ£€æŸ¥å“åº”ï¼Œä½†å¯ä»¥å‡è®¾å¦‚æœæ²¡æœ‰é”™è¯¯å°±æ˜¯å¯è®¿é—®çš„
                updateCheckStatus('pages', 'pass', 'âœ…', 'GitHub Pageså¯è®¿é—®');
                validationResults.pages = { success: true, message: 'GitHub Pageså¯è®¿é—®', url: pagesUrl };
            } catch (error) {
                updateCheckStatus('pages', 'fail', 'âŒ', `Pagesæ£€æŸ¥å¤±è´¥: ${error.message}`);
                validationResults.pages = { success: false, message: error.message };
            }
        }
        
        async function validateFileStructure(username, repo, token) {
            updateCheckStatus('files', 'pending', 'ğŸ”„', 'æ£€æŸ¥ä¸­...');
            
            try {
                const headers = token ? { 'Authorization': `token ${token}` } : {};
                const requiredFiles = ['generate_nav.py', '.github/workflows/deploy.yml'];
                const results = [];
                
                for (const file of requiredFiles) {
                    try {
                        const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${file}`, {
                            headers: headers
                        });
                        results.push({ file, exists: response.ok });
                    } catch (error) {
                        results.push({ file, exists: false });
                    }
                }
                
                const existingFiles = results.filter(r => r.exists);
                const missingFiles = results.filter(r => !r.exists);
                
                if (missingFiles.length === 0) {
                    updateCheckStatus('files', 'pass', 'âœ…', 'æ‰€æœ‰å¿…è¦æ–‡ä»¶éƒ½å­˜åœ¨');
                    validationResults.files = { success: true, message: 'æ‰€æœ‰å¿…è¦æ–‡ä»¶éƒ½å­˜åœ¨', results };
                } else {
                    updateCheckStatus('files', 'fail', 'âŒ', `ç¼ºå°‘æ–‡ä»¶: ${missingFiles.map(f => f.file).join(', ')}`);
                    validationResults.files = { success: false, message: 'ç¼ºå°‘å¿…è¦æ–‡ä»¶', results };
                }
            } catch (error) {
                updateCheckStatus('files', 'fail', 'âŒ', `æ–‡ä»¶æ£€æŸ¥å¤±è´¥: ${error.message}`);
                validationResults.files = { success: false, message: error.message };
            }
        }
        
        async function validatePublishFlow(webhookUrl) {
            updateCheckStatus('publish', 'pending', 'ğŸ”„', 'æ¨¡æ‹Ÿå‘å¸ƒä¸­...');
            
            try {
                const testData = {
                    htmlContent: '<!DOCTYPE html><html><head><title>é…ç½®éªŒè¯æµ‹è¯•</title></head><body><h1>è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•é¡µé¢</h1><p>ç”¨äºéªŒè¯N8Nå·¥ä½œæµé…ç½®ã€‚</p></body></html>',
                    fileName: 'config-validation-test.html',
                    commitMessage: 'é…ç½®éªŒè¯æµ‹è¯• - è‡ªåŠ¨ç”Ÿæˆ'
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateCheckStatus('publish', 'pass', 'âœ…', 'å‘å¸ƒæµ‹è¯•æˆåŠŸ');
                    validationResults.publish = { success: true, message: 'å‘å¸ƒæµ‹è¯•æˆåŠŸ', result };
                } else {
                    updateCheckStatus('publish', 'fail', 'âŒ', `å‘å¸ƒå¤±è´¥: ${result.error || result.message}`);
                    validationResults.publish = { success: false, message: result.error || result.message };
                }
            } catch (error) {
                updateCheckStatus('publish', 'fail', 'âŒ', `å‘å¸ƒæµ‹è¯•å¤±è´¥: ${error.message}`);
                validationResults.publish = { success: false, message: error.message };
            }
        }
        
        function updateCheckStatus(checkType, status, icon, message) {
            const checkElement = document.getElementById(`check-${checkType}`);
            const iconElement = document.getElementById(`check-${checkType}-icon`);
            const statusElement = document.getElementById(`check-${checkType}-status`);
            
            // æ›´æ–°æ ·å¼
            checkElement.className = `check-item p-4 rounded-lg border check-${status}`;
            iconElement.textContent = icon;
            statusElement.textContent = message;
        }
        
        function showOverallResult() {
            const totalChecks = Object.keys(validationResults).length;
            const passedChecks = Object.values(validationResults).filter(r => r.success).length;
            const failedChecks = totalChecks - passedChecks;
            
            const overallResult = document.getElementById('overallResult');
            const overallIcon = document.getElementById('overallIcon');
            const overallTitle = document.getElementById('overallTitle');
            const overallDesc = document.getElementById('overallDesc');
            const overallActions = document.getElementById('overallActions');
            
            if (failedChecks === 0) {
                overallResult.className = 'mt-8 p-6 rounded-lg border-2 border-green-500 bg-green-50';
                overallIcon.textContent = 'ğŸ‰';
                overallTitle.textContent = 'é…ç½®éªŒè¯é€šè¿‡ï¼';
                overallDesc.textContent = 'æ‰€æœ‰æ£€æŸ¥éƒ½å·²é€šè¿‡ï¼Œä½ çš„N8Nå·¥ä½œæµé…ç½®æ­£ç¡®ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚';
            } else if (passedChecks > failedChecks) {
                overallResult.className = 'mt-8 p-6 rounded-lg border-2 border-yellow-500 bg-yellow-50';
                overallIcon.textContent = 'âš ï¸';
                overallTitle.textContent = 'é…ç½®åŸºæœ¬æ­£å¸¸';
                overallDesc.textContent = `${passedChecks}é¡¹æ£€æŸ¥é€šè¿‡ï¼Œ${failedChecks}é¡¹éœ€è¦æ³¨æ„ã€‚å»ºè®®ä¿®å¤å¤±è´¥é¡¹åé‡æ–°æµ‹è¯•ã€‚`;
            } else {
                overallResult.className = 'mt-8 p-6 rounded-lg border-2 border-red-500 bg-red-50';
                overallIcon.textContent = 'âŒ';
                overallTitle.textContent = 'é…ç½®å­˜åœ¨é—®é¢˜';
                overallDesc.textContent = `${failedChecks}é¡¹æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ ¹æ®ä¸Šæ–¹æç¤ºä¿®å¤åé‡æ–°éªŒè¯ã€‚`;
            }
            
            overallActions.classList.remove('hidden');
        }
        
        function downloadReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: Object.keys(validationResults).length,
                    passed: Object.values(validationResults).filter(r => r.success).length,
                    failed: Object.values(validationResults).filter(r => !r.success).length
                },
                details: validationResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `n8n-validation-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function testPublish() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            if (webhookUrl) {
                window.open('content-publisher-form.html', '_blank');
            } else {
                alert('è¯·å…ˆå¡«å†™å¹¶éªŒè¯N8N Webhook URL');
            }
        }
    </script>
</body>
</html>