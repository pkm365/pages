<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML å†…å®¹å‘å¸ƒå™¨ - äº‘ç«¯ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .form-field {
            margin-bottom: 1.5rem;
        }
        
        .textarea-large {
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .progress-bar {
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .status-message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none;
        }
        
        .status-success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .status-error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .status-loading {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .file-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .char-counter {
            font-size: 0.8rem;
            color: #6b7280;
            text-align: right;
            margin-top: 0.25rem;
        }

        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }

        .button-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-1px);
        }

        .form-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .icon-upload {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .config-status {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .config-ready {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .config-warning {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto py-8">
        <div class="form-container bg-white rounded-xl shadow-xl">
            <!-- Header -->
            <div class="form-header">
                <div class="icon-upload">
                    â˜ï¸
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">HTML å†…å®¹å‘å¸ƒå™¨</h1>
                <p class="text-gray-600">äº‘ç«¯N8Nè‡ªåŠ¨åŒ–å‘å¸ƒç³»ç»Ÿ</p>
            </div>

            <!-- Configuration Status -->
            <div id="configStatus" class="config-status config-warning">
                âš™ï¸ æ­£åœ¨æ£€æŸ¥é…ç½®...
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-1 mb-6">
                <div id="progressBar" class="progress-bar w-0"></div>
            </div>

            <!-- Form -->
            <form id="contentForm">
                <!-- HTML Content Field -->
                <div class="form-field">
                    <label for="htmlContent" class="block text-sm font-semibold text-gray-700 mb-2">
                        HTML å†…å®¹ <span class="text-red-500">*</span>
                    </label>
                    <textarea 
                        id="htmlContent" 
                        name="htmlContent" 
                        class="textarea-large w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y"
                        placeholder="è¯·ç²˜è´´æ‚¨çš„å®Œæ•´HTMLå†…å®¹...&#10;&#10;ä¾‹å¦‚ï¼š&#10;&lt;!DOCTYPE html&gt;&#10;&lt;html&gt;&#10;&lt;head&gt;&#10;    &lt;title&gt;æˆ‘çš„é¡µé¢&lt;/title&gt;&#10;&lt;/head&gt;&#10;&lt;body&gt;&#10;    &lt;h1&gt;æ¬¢è¿æ¥åˆ°æˆ‘çš„é¡µé¢&lt;/h1&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;"
                        required
                    ></textarea>
                    <div class="char-counter">
                        <span id="charCount">0</span> å­—ç¬¦ | æœ€å¤§ <span id="maxSize">1024</span>KB
                    </div>
                </div>

                <!-- File Name Field -->
                <div class="form-field">
                    <label for="fileName" class="block text-sm font-semibold text-gray-700 mb-2">
                        æ–‡ä»¶å <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="fileName" 
                            name="fileName" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-16"
                            placeholder="example"
                            pattern="[a-zA-Z0-9\\s\\-_\\.\\u4e00-\\u9fa5]+"
                            required
                        >
                        <span class="absolute right-3 top-3 text-gray-500">.html</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">åªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸­æ–‡ã€ç©ºæ ¼ã€è¿å­—ç¬¦å’Œä¸‹åˆ’çº¿</p>
                </div>

                <!-- Commit Message Field -->
                <div class="form-field">
                    <label for="commitMessage" class="block text-sm font-semibold text-gray-700 mb-2">
                        æäº¤è¯´æ˜ <span class="text-gray-400">(å¯é€‰)</span>
                    </label>
                    <input 
                        type="text" 
                        id="commitMessage" 
                        name="commitMessage" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="æ·»åŠ æ–°å†…å®¹é¡µé¢"
                    >
                </div>

                <!-- Submit Button -->
                <div class="form-field">
                    <button 
                        type="submit" 
                        id="submitBtn"
                        class="button-primary w-full text-white font-bold py-4 px-6 rounded-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        <span id="submitText">âš™ï¸ æ£€æŸ¥é…ç½®ä¸­...</span>
                        <span id="loadingSpinner" class="hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            å¤„ç†ä¸­...
                        </span>
                    </button>
                </div>
            </form>

            <!-- Status Messages -->
            <div id="statusMessage" class="status-message">
                <div id="statusContent"></div>
            </div>

            <!-- File Preview -->
            <div id="previewSection" class="hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">å†…å®¹é¢„è§ˆ</h3>
                <div id="filePreview" class="file-preview"></div>
            </div>

            <!-- Configuration Info -->
            <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-2">ğŸ”§ ç³»ç»Ÿé…ç½®</h3>
                <div class="text-sm text-blue-700 space-y-1">
                    <div>N8NæœåŠ¡å™¨: <span id="n8nServer" class="font-mono">æ£€æŸ¥ä¸­...</span></div>
                    <div>GitHubä»“åº“: <span id="githubRepo" class="font-mono">æ£€æŸ¥ä¸­...</span></div>
                    <div>å‘å¸ƒåœ°å€: <span id="pagesUrl" class="font-mono">æ£€æŸ¥ä¸­...</span></div>
                </div>
            </div>

            <!-- Help Section -->
            <div class="mt-6 p-4 bg-green-50 rounded-lg">
                <h3 class="font-semibold text-green-800 mb-2">ğŸ’¡ ä½¿ç”¨æç¤º</h3>
                <ul class="text-sm text-green-700 space-y-1">
                    <li>â€¢ ç³»ç»Ÿä¼šè‡ªåŠ¨ä»ç¯å¢ƒé…ç½®ä¸­è¯»å–è®¾ç½®</li>
                    <li>â€¢ è¯·ç¡®ä¿HTMLå†…å®¹å®Œæ•´ï¼ŒåŒ…å«å¿…è¦çš„æ ‡ç­¾ç»“æ„</li>
                    <li>â€¢ å‘å¸ƒåçº¦1-2åˆ†é’Ÿå†…å®¹ä¼šåœ¨GitHub Pagesä¸Šå¯ç”¨</li>
                    <li>â€¢ ç³»ç»Ÿä¼šè‡ªåŠ¨æ›´æ–°å¯¼èˆªé¡µé¢å¹¶åˆ†ç±»æ‚¨çš„å†…å®¹</li>
                    <li>â€¢ å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æˆ–è”ç³»ç®¡ç†å‘˜</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®å¯¹è±¡ - ä»ç¯å¢ƒä¸­åŠ¨æ€åŠ è½½
        const config = {
            webhookUrl: '',
            githubOwner: '',
            githubRepo: '',
            pagesUrl: '',
            maxFileSize: 1024, // KB
            maxRequestsPerHour: 50
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–é…ç½®
        window.addEventListener('load', async function() {
            await loadConfiguration();
            initializeForm();
        });

        async function loadConfiguration() {
            try {
                // å°è¯•ä»å¤šä¸ªæ¥æºåŠ è½½é…ç½®
                await loadFromEnvironment();
                await validateConfiguration();
                updateConfigurationDisplay();
            } catch (error) {
                console.error('é…ç½®åŠ è½½å¤±è´¥:', error);
                showConfigurationError(error.message);
            }
        }

        async function loadFromEnvironment() {
            // æ–¹æ³•1: ä»å½“å‰é¡µé¢çš„URLå‚æ•°åŠ è½½
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('webhook')) {
                config.webhookUrl = urlParams.get('webhook');
            }

            // æ–¹æ³•2: ä»localStorageåŠ è½½ï¼ˆå¦‚æœä¹‹å‰ä¿å­˜è¿‡ï¼‰
            const savedConfig = localStorage.getItem('n8n-publisher-config');
            if (savedConfig) {
                const parsed = JSON.parse(savedConfig);
                Object.assign(config, parsed);
            }

            // æ–¹æ³•3: ä»é…ç½®APIç«¯ç‚¹åŠ è½½ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            try {
                const response = await fetch('./config.json');
                if (response.ok) {
                    const envConfig = await response.json();
                    Object.assign(config, envConfig);
                }
            } catch (error) {
                // é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼
            }

            // æ–¹æ³•4: ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆåŸºäº.envæ–‡ä»¶çš„å€¼ï¼‰
            if (!config.webhookUrl) {
                config.webhookUrl = 'https://n8n.pkm365.com/webhook/content-publisher';
                config.githubOwner = 'pkm365';
                config.githubRepo = 'pages';
                config.pagesUrl = 'https://pkm365.github.io/pages';
            }
        }

        async function validateConfiguration() {
            // éªŒè¯å¿…è¦çš„é…ç½®é¡¹
            if (!config.webhookUrl) {
                throw new Error('N8N Webhook URLæœªé…ç½®');
            }

            if (!config.githubOwner || !config.githubRepo) {
                throw new Error('GitHubä»“åº“ä¿¡æ¯æœªé…ç½®');
            }

            // æµ‹è¯•N8Nè¿æ¥
            try {
                const response = await fetch(config.webhookUrl + '?test=ping', {
                    method: 'GET',
                    mode: 'no-cors'
                });
                // ç”±äºCORSé™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥æ£€æŸ¥å“åº”ï¼Œä½†æ²¡æœ‰æŠ›å‡ºé”™è¯¯å°±è¡¨ç¤ºURLå¯è®¿é—®
            } catch (error) {
                console.warn('N8Nè¿æ¥æµ‹è¯•å¤±è´¥:', error);
                // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºå¯èƒ½æ˜¯CORSé—®é¢˜ï¼Œå®é™…POSTè¯·æ±‚å¯èƒ½å·¥ä½œæ­£å¸¸
            }
        }

        function updateConfigurationDisplay() {
            document.getElementById('n8nServer').textContent = config.webhookUrl.split('/')[2];
            document.getElementById('githubRepo').textContent = `${config.githubOwner}/${config.githubRepo}`;
            document.getElementById('pagesUrl').textContent = config.pagesUrl;
            document.getElementById('maxSize').textContent = config.maxFileSize;

            // æ›´æ–°é…ç½®çŠ¶æ€
            const configStatus = document.getElementById('configStatus');
            configStatus.className = 'config-status config-ready';
            configStatus.innerHTML = 'âœ… ç³»ç»Ÿé…ç½®å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨';

            // å¯ç”¨æäº¤æŒ‰é’®
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = false;
            document.getElementById('submitText').textContent = 'ğŸš€ å‘å¸ƒå†…å®¹';
        }

        function showConfigurationError(message) {
            const configStatus = document.getElementById('configStatus');
            configStatus.className = 'config-status config-warning';
            configStatus.innerHTML = `âŒ é…ç½®é”™è¯¯: ${message}`;

            showStatus('error', `é…ç½®åŠ è½½å¤±è´¥: ${message}. è¯·æ£€æŸ¥ç¯å¢ƒé…ç½®æˆ–è”ç³»ç®¡ç†å‘˜ã€‚`);
        }

        function initializeForm() {
            const form = document.getElementById('contentForm');
            const htmlContent = document.getElementById('htmlContent');
            const fileName = document.getElementById('fileName');
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const statusMessage = document.getElementById('statusMessage');
            const statusContent = document.getElementById('statusContent');
            const progressBar = document.getElementById('progressBar');
            const charCount = document.getElementById('charCount');
            const previewSection = document.getElementById('previewSection');
            const filePreview = document.getElementById('filePreview');

            // å­—ç¬¦è®¡æ•°å™¨å’Œå¤§å°æ£€æŸ¥
            htmlContent.addEventListener('input', function() {
                const count = this.value.length;
                const sizeKB = new Blob([this.value]).size / 1024;
                
                charCount.textContent = count.toLocaleString();
                
                // æ›´æ–°è¿›åº¦æ¡
                const progress = Math.min((count / 1000) * 100, 100);
                progressBar.style.width = progress + '%';

                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                if (sizeKB > config.maxFileSize) {
                    charCount.style.color = '#ef4444';
                    charCount.textContent += ` (è¶…å‡ºé™åˆ¶ ${sizeKB.toFixed(1)}KB)`;
                    submitBtn.disabled = true;
                } else {
                    charCount.style.color = '#6b7280';
                    submitBtn.disabled = false;
                }

                // å®æ—¶é¢„è§ˆ
                if (this.value.trim()) {
                    previewSection.classList.remove('hidden');
                    filePreview.textContent = this.value.substring(0, 500) + (this.value.length > 500 ? '...' : '');
                } else {
                    previewSection.classList.add('hidden');
                }
            });

            // æ–‡ä»¶åè‡ªåŠ¨æ ¼å¼åŒ–
            fileName.addEventListener('input', function() {
                this.value = this.value.replace(/[^a-zA-Z0-9\s\-_.\u4e00-\u9fa5]/g, '');
            });

            // è¡¨å•æäº¤
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!htmlContent.value.trim() || !fileName.value.trim()) {
                    showStatus('error', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                    return;
                }

                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                const sizeKB = new Blob([htmlContent.value]).size / 1024;
                if (sizeKB > config.maxFileSize) {
                    showStatus('error', `æ–‡ä»¶å¤§å° ${sizeKB.toFixed(1)}KB è¶…å‡ºé™åˆ¶ ${config.maxFileSize}KB`);
                    return;
                }

                setLoading(true);
                showStatus('loading', 'æ­£åœ¨å‘å¸ƒå†…å®¹åˆ°äº‘ç«¯N8NæœåŠ¡å™¨...');

                try {
                    const formData = {
                        htmlContent: htmlContent.value,
                        fileName: fileName.value + '.html'
                    };

                    const response = await fetch(config.webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Webhook-Source': 'content-publisher'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();
                    console.log('N8Nå“åº”:', result);

                    if (result.success) {
                        // å…¼å®¹N8Nå½“å‰å“åº”æ ¼å¼ï¼šå¤„ç†æœªè§£æçš„æ¨¡æ¿å˜é‡
                        const fileName = (result.fileName && !result.fileName.includes('={{')) ? 
                            result.fileName : formData.fileName;
                        const baseUrl = config.pagesUrl || 'https://pkm365.github.io/pages';
                        const previewUrl = `${baseUrl}/${fileName}`;
                        const indexUrl = baseUrl;
                        const githubUrl = `https://github.com/${config.githubOwner}/${config.githubRepo}/blob/main/${fileName}`;
                        const timestamp = (result.timestamp && !result.timestamp.includes('={{')) ? 
                            result.timestamp : new Date().toISOString();
                        
                        showStatus('success', `
                            <strong>ğŸ‰ å‘å¸ƒæˆåŠŸï¼</strong><br>
                            <div class="mt-2 space-y-1">
                                <div>ğŸ“ æ–‡ä»¶: ${fileName}</div>
                                <div>ğŸ“ å‘å¸ƒæ—¶é—´: ${new Date(timestamp).toLocaleString('zh-CN')}</div>
                                <div class="mt-3">
                                    <a href="${previewUrl}" target="_blank" class="text-blue-600 hover:underline">ğŸ”— æŸ¥çœ‹é¡µé¢</a> |
                                    <a href="${indexUrl}" target="_blank" class="text-blue-600 hover:underline">ğŸ  è¿”å›é¦–é¡µ</a> |
                                    <a href="${githubUrl}" target="_blank" class="text-blue-600 hover:underline">ğŸ“‹ GitHubæºç </a>
                                </div>
                            </div>
                            <div class="mt-2 text-sm opacity-75">å†…å®¹å°†åœ¨1-2åˆ†é’Ÿå†…å¯ç”¨</div>
                        `);
                        
                        // ä¿å­˜æˆåŠŸçš„é…ç½®
                        localStorage.setItem('n8n-publisher-config', JSON.stringify(config));
                        
                        // é‡ç½®è¡¨å•
                        setTimeout(() => {
                            form.reset();
                            charCount.textContent = '0';
                            progressBar.style.width = '0%';
                            previewSection.classList.add('hidden');
                        }, 2000);
                    } else {
                        showStatus('error', `âŒ å‘å¸ƒå¤±è´¥: ${result.error || result.message}`);
                    }
                } catch (error) {
                    console.error('å‘å¸ƒé”™è¯¯:', error);
                    showStatus('error', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}. è¯·æ£€æŸ¥N8NæœåŠ¡å™¨è¿æ¥ã€‚`);
                } finally {
                    setLoading(false);
                }
            });
        }

        function setLoading(loading) {
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            submitBtn.disabled = loading;
            if (loading) {
                submitText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                submitText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        function showStatus(type, message) {
            const statusMessage = document.getElementById('statusMessage');
            const statusContent = document.getElementById('statusContent');
            
            statusMessage.className = `status-message status-${type}`;
            statusContent.innerHTML = message;
            statusMessage.style.display = 'block';
            
            // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 10000);
            }

            // æ»šåŠ¨åˆ°çŠ¶æ€æ¶ˆæ¯
            statusMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>
</html>