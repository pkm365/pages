<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML 内容发布器 - 云端版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .form-field {
            margin-bottom: 1.5rem;
        }
        
        .textarea-large {
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .progress-bar {
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .status-message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none;
        }
        
        .status-success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .status-error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .status-loading {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .file-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .char-counter {
            font-size: 0.8rem;
            color: #6b7280;
            text-align: right;
            margin-top: 0.25rem;
        }

        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }

        .button-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-1px);
        }

        .form-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .icon-upload {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .config-status {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .config-ready {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .config-warning {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto py-8">
        <div class="form-container bg-white rounded-xl shadow-xl">
            <!-- Header -->
            <div class="form-header">
                <div class="icon-upload">
                    ☁️
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">HTML 内容发布器</h1>
                <p class="text-gray-600">云端N8N自动化发布系统</p>
            </div>

            <!-- Configuration Status -->
            <div id="configStatus" class="config-status config-warning">
                ⚙️ 正在检查配置...
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-1 mb-6">
                <div id="progressBar" class="progress-bar w-0"></div>
            </div>

            <!-- Form -->
            <form id="contentForm">
                <!-- HTML Content Field -->
                <div class="form-field">
                    <label for="htmlContent" class="block text-sm font-semibold text-gray-700 mb-2">
                        HTML 内容 <span class="text-red-500">*</span>
                    </label>
                    <textarea 
                        id="htmlContent" 
                        name="htmlContent" 
                        class="textarea-large w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y"
                        placeholder="请粘贴您的完整HTML内容...&#10;&#10;例如：&#10;&lt;!DOCTYPE html&gt;&#10;&lt;html&gt;&#10;&lt;head&gt;&#10;    &lt;title&gt;我的页面&lt;/title&gt;&#10;&lt;/head&gt;&#10;&lt;body&gt;&#10;    &lt;h1&gt;欢迎来到我的页面&lt;/h1&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;"
                        required
                    ></textarea>
                    <div class="char-counter">
                        <span id="charCount">0</span> 字符 | 最大 <span id="maxSize">1024</span>KB
                    </div>
                </div>

                <!-- File Name Field -->
                <div class="form-field">
                    <label for="fileName" class="block text-sm font-semibold text-gray-700 mb-2">
                        文件名 <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="fileName" 
                            name="fileName" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-16"
                            placeholder="example"
                            pattern="[a-zA-Z0-9\\s\\-_\\.\\u4e00-\\u9fa5]+"
                            required
                        >
                        <span class="absolute right-3 top-3 text-gray-500">.html</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">只允许字母、数字、中文、空格、连字符和下划线</p>
                </div>

                <!-- Commit Message Field -->
                <div class="form-field">
                    <label for="commitMessage" class="block text-sm font-semibold text-gray-700 mb-2">
                        提交说明 <span class="text-gray-400">(可选)</span>
                    </label>
                    <input 
                        type="text" 
                        id="commitMessage" 
                        name="commitMessage" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="添加新内容页面"
                    >
                </div>

                <!-- Submit Button -->
                <div class="form-field">
                    <button 
                        type="submit" 
                        id="submitBtn"
                        class="button-primary w-full text-white font-bold py-4 px-6 rounded-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        <span id="submitText">⚙️ 检查配置中...</span>
                        <span id="loadingSpinner" class="hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            处理中...
                        </span>
                    </button>
                </div>
            </form>

            <!-- Status Messages -->
            <div id="statusMessage" class="status-message">
                <div id="statusContent"></div>
            </div>

            <!-- File Preview -->
            <div id="previewSection" class="hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">内容预览</h3>
                <div id="filePreview" class="file-preview"></div>
            </div>

            <!-- Configuration Info -->
            <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-2">🔧 系统配置</h3>
                <div class="text-sm text-blue-700 space-y-1">
                    <div>N8N服务器: <span id="n8nServer" class="font-mono">检查中...</span></div>
                    <div>GitHub仓库: <span id="githubRepo" class="font-mono">检查中...</span></div>
                    <div>发布地址: <span id="pagesUrl" class="font-mono">检查中...</span></div>
                </div>
            </div>

            <!-- Help Section -->
            <div class="mt-6 p-4 bg-green-50 rounded-lg">
                <h3 class="font-semibold text-green-800 mb-2">💡 使用提示</h3>
                <ul class="text-sm text-green-700 space-y-1">
                    <li>• 系统会自动从环境配置中读取设置</li>
                    <li>• 请确保HTML内容完整，包含必要的标签结构</li>
                    <li>• 发布后约1-2分钟内容会在GitHub Pages上可用</li>
                    <li>• 系统会自动更新导航页面并分类您的内容</li>
                    <li>• 如遇问题，请检查浏览器控制台或联系管理员</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 配置对象 - 从环境中动态加载
        const config = {
            webhookUrl: '',
            githubOwner: '',
            githubRepo: '',
            pagesUrl: '',
            maxFileSize: 1024, // KB
            maxRequestsPerHour: 50
        };

        // 页面加载时初始化配置
        window.addEventListener('load', async function() {
            await loadConfiguration();
            initializeForm();
        });

        async function loadConfiguration() {
            try {
                // 尝试从多个来源加载配置
                await loadFromEnvironment();
                await validateConfiguration();
                updateConfigurationDisplay();
            } catch (error) {
                console.error('配置加载失败:', error);
                showConfigurationError(error.message);
            }
        }

        async function loadFromEnvironment() {
            // 方法1: 从当前页面的URL参数加载
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('webhook')) {
                config.webhookUrl = urlParams.get('webhook');
            }

            // 方法2: 从localStorage加载（如果之前保存过）
            const savedConfig = localStorage.getItem('n8n-publisher-config');
            if (savedConfig) {
                const parsed = JSON.parse(savedConfig);
                Object.assign(config, parsed);
            }

            // 方法3: 从配置API端点加载（如果可用）
            try {
                const response = await fetch('./config.json');
                if (response.ok) {
                    const envConfig = await response.json();
                    Object.assign(config, envConfig);
                }
            } catch (error) {
                // 配置文件不存在，使用默认值
            }

            // 方法4: 使用默认配置（基于.env文件的值）
            if (!config.webhookUrl) {
                config.webhookUrl = 'https://n8n.pkm365.com/webhook/content-publisher';
                config.githubOwner = 'pkm365';
                config.githubRepo = 'pages';
                config.pagesUrl = 'https://pkm365.github.io/pages';
            }
        }

        async function validateConfiguration() {
            // 验证必要的配置项
            if (!config.webhookUrl) {
                throw new Error('N8N Webhook URL未配置');
            }

            if (!config.githubOwner || !config.githubRepo) {
                throw new Error('GitHub仓库信息未配置');
            }

            // 测试N8N连接
            try {
                const response = await fetch(config.webhookUrl + '?test=ping', {
                    method: 'GET',
                    mode: 'no-cors'
                });
                // 由于CORS限制，我们无法直接检查响应，但没有抛出错误就表示URL可访问
            } catch (error) {
                console.warn('N8N连接测试失败:', error);
                // 不抛出错误，因为可能是CORS问题，实际POST请求可能工作正常
            }
        }

        function updateConfigurationDisplay() {
            document.getElementById('n8nServer').textContent = config.webhookUrl.split('/')[2];
            document.getElementById('githubRepo').textContent = `${config.githubOwner}/${config.githubRepo}`;
            document.getElementById('pagesUrl').textContent = config.pagesUrl;
            document.getElementById('maxSize').textContent = config.maxFileSize;

            // 更新配置状态
            const configStatus = document.getElementById('configStatus');
            configStatus.className = 'config-status config-ready';
            configStatus.innerHTML = '✅ 系统配置已加载，可以开始使用';

            // 启用提交按钮
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = false;
            document.getElementById('submitText').textContent = '🚀 发布内容';
        }

        function showConfigurationError(message) {
            const configStatus = document.getElementById('configStatus');
            configStatus.className = 'config-status config-warning';
            configStatus.innerHTML = `❌ 配置错误: ${message}`;

            showStatus('error', `配置加载失败: ${message}. 请检查环境配置或联系管理员。`);
        }

        function initializeForm() {
            const form = document.getElementById('contentForm');
            const htmlContent = document.getElementById('htmlContent');
            const fileName = document.getElementById('fileName');
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const statusMessage = document.getElementById('statusMessage');
            const statusContent = document.getElementById('statusContent');
            const progressBar = document.getElementById('progressBar');
            const charCount = document.getElementById('charCount');
            const previewSection = document.getElementById('previewSection');
            const filePreview = document.getElementById('filePreview');

            // 字符计数器和大小检查
            htmlContent.addEventListener('input', function() {
                const count = this.value.length;
                const sizeKB = new Blob([this.value]).size / 1024;
                
                charCount.textContent = count.toLocaleString();
                
                // 更新进度条
                const progress = Math.min((count / 1000) * 100, 100);
                progressBar.style.width = progress + '%';

                // 检查文件大小
                if (sizeKB > config.maxFileSize) {
                    charCount.style.color = '#ef4444';
                    charCount.textContent += ` (超出限制 ${sizeKB.toFixed(1)}KB)`;
                    submitBtn.disabled = true;
                } else {
                    charCount.style.color = '#6b7280';
                    submitBtn.disabled = false;
                }

                // 实时预览
                if (this.value.trim()) {
                    previewSection.classList.remove('hidden');
                    filePreview.textContent = this.value.substring(0, 500) + (this.value.length > 500 ? '...' : '');
                } else {
                    previewSection.classList.add('hidden');
                }
            });

            // 文件名自动格式化
            fileName.addEventListener('input', function() {
                this.value = this.value.replace(/[^a-zA-Z0-9\s\-_.\u4e00-\u9fa5]/g, '');
            });

            // 表单提交
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!htmlContent.value.trim() || !fileName.value.trim()) {
                    showStatus('error', '请填写所有必填字段');
                    return;
                }

                // 检查文件大小
                const sizeKB = new Blob([htmlContent.value]).size / 1024;
                if (sizeKB > config.maxFileSize) {
                    showStatus('error', `文件大小 ${sizeKB.toFixed(1)}KB 超出限制 ${config.maxFileSize}KB`);
                    return;
                }

                setLoading(true);
                showStatus('loading', '正在发布内容到云端N8N服务器...');

                try {
                    const formData = {
                        htmlContent: htmlContent.value,
                        fileName: fileName.value + '.html'
                    };

                    const response = await fetch(config.webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Webhook-Source': 'content-publisher'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();
                    console.log('N8N响应:', result);

                    if (result.success) {
                        // 兼容N8N当前响应格式：处理未解析的模板变量
                        const fileName = (result.fileName && !result.fileName.includes('={{')) ? 
                            result.fileName : formData.fileName;
                        const baseUrl = config.pagesUrl || 'https://pkm365.github.io/pages';
                        const previewUrl = `${baseUrl}/${fileName}`;
                        const indexUrl = baseUrl;
                        const githubUrl = `https://github.com/${config.githubOwner}/${config.githubRepo}/blob/main/${fileName}`;
                        const timestamp = (result.timestamp && !result.timestamp.includes('={{')) ? 
                            result.timestamp : new Date().toISOString();
                        
                        showStatus('success', `
                            <strong>🎉 发布成功！</strong><br>
                            <div class="mt-2 space-y-1">
                                <div>📁 文件: ${fileName}</div>
                                <div>📝 发布时间: ${new Date(timestamp).toLocaleString('zh-CN')}</div>
                                <div class="mt-3">
                                    <a href="${previewUrl}" target="_blank" class="text-blue-600 hover:underline">🔗 查看页面</a> |
                                    <a href="${indexUrl}" target="_blank" class="text-blue-600 hover:underline">🏠 返回首页</a> |
                                    <a href="${githubUrl}" target="_blank" class="text-blue-600 hover:underline">📋 GitHub源码</a>
                                </div>
                            </div>
                            <div class="mt-2 text-sm opacity-75">内容将在1-2分钟内可用</div>
                        `);
                        
                        // 保存成功的配置
                        localStorage.setItem('n8n-publisher-config', JSON.stringify(config));
                        
                        // 重置表单
                        setTimeout(() => {
                            form.reset();
                            charCount.textContent = '0';
                            progressBar.style.width = '0%';
                            previewSection.classList.add('hidden');
                        }, 2000);
                    } else {
                        showStatus('error', `❌ 发布失败: ${result.error || result.message}`);
                    }
                } catch (error) {
                    console.error('发布错误:', error);
                    showStatus('error', `❌ 网络错误: ${error.message}. 请检查N8N服务器连接。`);
                } finally {
                    setLoading(false);
                }
            });
        }

        function setLoading(loading) {
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            submitBtn.disabled = loading;
            if (loading) {
                submitText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                submitText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        function showStatus(type, message) {
            const statusMessage = document.getElementById('statusMessage');
            const statusContent = document.getElementById('statusContent');
            
            statusMessage.className = `status-message status-${type}`;
            statusContent.innerHTML = message;
            statusMessage.style.display = 'block';
            
            // 自动隐藏成功消息
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 10000);
            }

            // 滚动到状态消息
            statusMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>
</html>