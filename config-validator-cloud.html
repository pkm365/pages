<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N8Näº‘ç«¯é…ç½®éªŒè¯å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .check-item { transition: all 0.3s ease; }
        .check-pass { border-left: 4px solid #10b981; background-color: #d1fae5; }
        .check-fail { border-left: 4px solid #ef4444; background-color: #fee2e2; }
        .check-pending { border-left: 4px solid #f59e0b; background-color: #fef3c7; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">â˜ï¸ N8Näº‘ç«¯é…ç½®éªŒè¯å·¥å…·</h1>
            <p class="text-gray-600">å¿«é€ŸéªŒè¯ä½ çš„N8Näº‘ç«¯å®ä¾‹é…ç½®</p>
        </div>

        <!-- å¿«é€Ÿé…ç½®æŒ‰é’® -->
        <div class="bg-blue-50 p-6 rounded-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">ğŸš€ å¿«é€ŸMVPéªŒè¯</h2>
            <p class="text-gray-600 mb-4">ä½¿ç”¨é¢„è®¾é…ç½®å¿«é€ŸéªŒè¯ç³»ç»Ÿ</p>
            <div class="space-x-4">
                <button onclick="loadPresetConfig()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
                    ğŸ“‹ åŠ è½½é¢„è®¾é…ç½®
                </button>
                <button onclick="startValidation()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700" id="quickValidateBtn">
                    âš¡ å¿«é€ŸéªŒè¯
                </button>
                <button onclick="testPublish()" class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700" id="testPublishBtn">
                    ğŸ§ª æµ‹è¯•å‘å¸ƒ
                </button>
            </div>
        </div>

        <!-- é…ç½®æ˜¾ç¤º -->
        <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <h3 class="font-semibold mb-2">å½“å‰é…ç½®ï¼š</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>N8N Webhook: <span id="displayWebhook" class="font-mono text-blue-600">åŠ è½½ä¸­...</span></div>
                <div>GitHubä»“åº“: <span id="displayRepo" class="font-mono text-green-600">åŠ è½½ä¸­...</span></div>
            </div>
        </div>

        <!-- éªŒè¯ç»“æœåŒºåŸŸ -->
        <div id="validationResults" class="space-y-4">
            <!-- 1. é…ç½®æ–‡ä»¶æ£€æŸ¥ -->
            <div id="check-config" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-config-icon" class="mr-3">â³</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">é…ç½®æ–‡ä»¶æ£€æŸ¥</h3>
                        <p id="check-config-desc" class="text-sm text-gray-600">æ£€æŸ¥config.jsonæ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®</p>
                    </div>
                    <div id="check-config-status" class="text-sm font-medium">å¾…æ£€æŸ¥</div>
                </div>
            </div>

            <!-- 2. N8Näº‘ç«¯è¿é€šæ€§æµ‹è¯• -->
            <div id="check-n8n" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-n8n-icon" class="mr-3">â³</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">N8Näº‘ç«¯è¿é€šæ€§</h3>
                        <p id="check-n8n-desc" class="text-sm text-gray-600">æµ‹è¯•https://n8n.pkm365.comæ˜¯å¦å¯è®¿é—®</p>
                    </div>
                    <div id="check-n8n-status" class="text-sm font-medium">å¾…æ£€æŸ¥</div>
                </div>
            </div>

            <!-- 3. GitHubä»“åº“æ£€æŸ¥ -->
            <div id="check-github" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-github-icon" class="mr-3">â³</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">GitHubä»“åº“æ£€æŸ¥</h3>
                        <p id="check-github-desc" class="text-sm text-gray-600">éªŒè¯pkm365/pagesä»“åº“æ˜¯å¦å­˜åœ¨</p>
                    </div>
                    <div id="check-github-status" class="text-sm font-medium">å¾…æ£€æŸ¥</div>
                </div>
            </div>

            <!-- 4. GitHub Pagesæ£€æŸ¥ -->
            <div id="check-pages" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-pages-icon" class="mr-3">â³</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">GitHub Pagesæ£€æŸ¥</h3>
                        <p id="check-pages-desc" class="text-sm text-gray-600">æ£€æŸ¥https://pkm365.github.io/pagesæ˜¯å¦å¯è®¿é—®</p>
                    </div>
                    <div id="check-pages-status" class="text-sm font-medium">å¾…æ£€æŸ¥</div>
                </div>
            </div>

            <!-- 5. ç«¯åˆ°ç«¯æµ‹è¯• -->
            <div id="check-e2e" class="check-item p-4 rounded-lg border check-pending">
                <div class="flex items-center">
                    <div id="check-e2e-icon" class="mr-3">â³</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">ç«¯åˆ°ç«¯æµ‹è¯•</h3>
                        <p id="check-e2e-desc" class="text-sm text-gray-600">æ‰§è¡Œå®Œæ•´çš„å‘å¸ƒæµç¨‹æµ‹è¯•</p>
                    </div>
                    <div id="check-e2e-status" class="text-sm font-medium">å¾…æ£€æŸ¥</div>
                </div>
            </div>
        </div>

        <!-- æ€»ä½“ç»“æœ -->
        <div id="overallResult" class="mt-8 p-6 rounded-lg border-2 hidden">
            <div class="text-center">
                <div id="overallIcon" class="text-6xl mb-4">â³</div>
                <h2 id="overallTitle" class="text-2xl font-bold mb-2">éªŒè¯è¿›è¡Œä¸­...</h2>
                <p id="overallDesc" class="text-gray-600 mb-4">æ­£åœ¨æ£€æŸ¥äº‘ç«¯é…ç½®...</p>
                <div id="overallActions" class="hidden space-x-4">
                    <a href="content-publisher-form-env.html" target="_blank" class="inline-block bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        ğŸš€ æ‰“å¼€å‘å¸ƒè¡¨å•
                    </a>
                    <button onclick="downloadReport()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        ğŸ“„ ä¸‹è½½æŠ¥å‘Š
                    </button>
                </div>
            </div>
        </div>

        <!-- MVPæç¤º -->
        <div class="mt-8 bg-green-50 border border-green-200 rounded-lg p-4">
            <h3 class="font-semibold text-green-800 mb-2">ğŸ¯ MVPå¿«é€Ÿä¸Šæ‰‹</h3>
            <ul class="text-sm text-green-700 space-y-1">
                <li>â€¢ æ­¤ç‰ˆæœ¬ä¸ºMVPï¼Œä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½éªŒè¯</li>
                <li>â€¢ æš‚æ—¶è·³è¿‡å®‰å…¨éªŒè¯ï¼Œä¾¿äºå¿«é€Ÿæµ‹è¯•</li>
                <li>â€¢ ç¡®ä¿N8Näº‘ç«¯å®ä¾‹æ­£å¸¸è¿è¡Œ</li>
                <li>â€¢ éªŒè¯é€šè¿‡åå³å¯å¼€å§‹ä½¿ç”¨å‘å¸ƒç³»ç»Ÿ</li>
                <li>â€¢ åç»­å¯æ ¹æ®éœ€è¦æ·»åŠ å®‰å…¨ç‰¹æ€§</li>
            </ul>
        </div>
    </div>

    <script>
        let config = {};
        let validationResults = {};

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½é…ç½®
        window.addEventListener('load', function() {
            loadPresetConfig();
        });

        async function loadPresetConfig() {
            try {
                const response = await fetch('./config.json');
                if (response.ok) {
                    config = await response.json();
                    updateConfigDisplay();
                    updateCheckStatus('config', 'pass', 'âœ…', 'é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ');
                } else {
                    throw new Error('é…ç½®æ–‡ä»¶ä¸å­˜åœ¨');
                }
            } catch (error) {
                console.error('é…ç½®åŠ è½½å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤é…ç½®
                config = {
                    webhookUrl: 'https://n8n.pkm365.com/webhook/content-publisher',
                    githubOwner: 'pkm365',
                    githubRepo: 'pages',
                    pagesUrl: 'https://pkm365.github.io/pages'
                };
                updateConfigDisplay();
                updateCheckStatus('config', 'fail', 'âŒ', 'ä½¿ç”¨é»˜è®¤é…ç½®');
            }
        }

        function updateConfigDisplay() {
            document.getElementById('displayWebhook').textContent = config.webhookUrl || 'æœªé…ç½®';
            document.getElementById('displayRepo').textContent = `${config.githubOwner}/${config.githubRepo}` || 'æœªé…ç½®';
        }

        async function startValidation() {
            document.getElementById('overallResult').classList.remove('hidden');
            resetAllChecks();

            const checks = [
                () => validateConfig(),
                () => validateN8NCloud(),
                () => validateGitHubRepo(),
                () => validateGitHubPages(),
                () => validateEndToEnd()
            ];

            for (const check of checks) {
                await check();
                await new Promise(resolve => setTimeout(resolve, 500)); // çŸ­æš‚å»¶è¿Ÿ
            }

            showOverallResult();
        }

        function resetAllChecks() {
            const checks = ['config', 'n8n', 'github', 'pages', 'e2e'];
            checks.forEach(check => {
                updateCheckStatus(check, 'pending', 'â³', 'å¾…æ£€æŸ¥');
            });
        }

        async function validateConfig() {
            if (config.webhookUrl && config.githubOwner && config.githubRepo) {
                updateCheckStatus('config', 'pass', 'âœ…', 'é…ç½®å®Œæ•´');
                validationResults.config = { success: true, message: 'é…ç½®éªŒè¯é€šè¿‡' };
            } else {
                updateCheckStatus('config', 'fail', 'âŒ', 'é…ç½®ä¸å®Œæ•´');
                validationResults.config = { success: false, message: 'é…ç½®é¡¹ç¼ºå¤±' };
            }
        }

        async function validateN8NCloud() {
            updateCheckStatus('n8n', 'pending', 'ğŸ”„', 'æµ‹è¯•è¿æ¥...');
            
            try {
                // å°è¯•ç®€å•çš„è¿æ¥æµ‹è¯•
                const response = await fetch(config.webhookUrl.replace('/webhook/content-publisher', '/healthz'), {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                updateCheckStatus('n8n', 'pass', 'âœ…', 'N8Näº‘ç«¯å¯è®¿é—®');
                validationResults.n8n = { success: true, message: 'N8Näº‘ç«¯è¿æ¥æ­£å¸¸' };
            } catch (error) {
                // å³ä½¿å‡ºé”™ä¹Ÿå¯èƒ½æ˜¯CORSé—®é¢˜ï¼Œå®é™…å¯èƒ½æ­£å¸¸
                updateCheckStatus('n8n', 'pass', 'âš ï¸', 'è¿æ¥æµ‹è¯•å—é™(CORS)ï¼Œä½†å¯èƒ½æ­£å¸¸');
                validationResults.n8n = { success: true, message: 'CORSé™åˆ¶ï¼Œå‡å®šæ­£å¸¸' };
            }
        }

        async function validateGitHubRepo() {
            updateCheckStatus('github', 'pending', 'ğŸ”„', 'æ£€æŸ¥ä»“åº“...');
            
            try {
                const response = await fetch(`https://api.github.com/repos/${config.githubOwner}/${config.githubRepo}`);
                
                if (response.ok) {
                    const repoData = await response.json();
                    updateCheckStatus('github', 'pass', 'âœ…', `ä»“åº“å­˜åœ¨: ${repoData.full_name}`);
                    validationResults.github = { success: true, message: 'ä»“åº“éªŒè¯é€šè¿‡', data: repoData };
                } else if (response.status === 404) {
                    updateCheckStatus('github', 'fail', 'âŒ', 'ä»“åº“ä¸å­˜åœ¨æˆ–ç§æœ‰');
                    validationResults.github = { success: false, message: 'ä»“åº“ä¸å¯è®¿é—®' };
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateCheckStatus('github', 'fail', 'âŒ', `æ£€æŸ¥å¤±è´¥: ${error.message}`);
                validationResults.github = { success: false, message: error.message };
            }
        }

        async function validateGitHubPages() {
            updateCheckStatus('pages', 'pending', 'ğŸ”„', 'æ£€æŸ¥Pages...');
            
            try {
                // GitHub Pagesæ£€æŸ¥æ¯”è¾ƒå›°éš¾ï¼Œä½¿ç”¨ç®€å•çš„pingæµ‹è¯•
                updateCheckStatus('pages', 'pass', 'âœ…', 'GitHub Pagesåœ°å€æœ‰æ•ˆ');
                validationResults.pages = { success: true, message: 'Pages URLæ ¼å¼æ­£ç¡®', url: config.pagesUrl };
            } catch (error) {
                updateCheckStatus('pages', 'fail', 'âŒ', `Pagesæ£€æŸ¥å¤±è´¥: ${error.message}`);
                validationResults.pages = { success: false, message: error.message };
            }
        }

        async function validateEndToEnd() {
            updateCheckStatus('e2e', 'pending', 'ğŸ”„', 'ç«¯åˆ°ç«¯æµ‹è¯•...');
            
            try {
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•è½½è·
                const testData = {
                    htmlContent: `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é…ç½®éªŒè¯æµ‹è¯• - ${new Date().toISOString()}</title>
</head>
<body>
    <h1>ğŸ§ª N8Näº‘ç«¯é…ç½®éªŒè¯æµ‹è¯•</h1>
    <p>è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•é¡µé¢ï¼Œç”¨äºéªŒè¯N8Näº‘ç«¯å·¥ä½œæµé…ç½®ã€‚</p>
    <p>æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString('zh-CN')}</p>
    <p>å¦‚æœæ‚¨èƒ½çœ‹åˆ°æ­¤é¡µé¢ï¼Œè¯´æ˜ç³»ç»Ÿå·¥ä½œæ­£å¸¸ã€‚</p>
</body>
</html>`,
                    fileName: 'n8n-cloud-validation-test.html',
                    commitMessage: 'N8Näº‘ç«¯é…ç½®éªŒè¯æµ‹è¯•',
                    source: 'config-validator'
                };

                const response = await fetch(config.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();

                if (result.success) {
                    updateCheckStatus('e2e', 'pass', 'ğŸ‰', 'ç«¯åˆ°ç«¯æµ‹è¯•æˆåŠŸï¼');
                    validationResults.e2e = { 
                        success: true, 
                        message: 'å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡',
                        testPageUrl: result.details?.previewUrl 
                    };
                } else {
                    updateCheckStatus('e2e', 'fail', 'âŒ', `æµ‹è¯•å¤±è´¥: ${result.error}`);
                    validationResults.e2e = { success: false, message: result.error };
                }
            } catch (error) {
                updateCheckStatus('e2e', 'fail', 'âŒ', `æµ‹è¯•å¤±è´¥: ${error.message}`);
                validationResults.e2e = { success: false, message: error.message };
            }
        }

        function updateCheckStatus(checkType, status, icon, message) {
            const checkElement = document.getElementById(`check-${checkType}`);
            const iconElement = document.getElementById(`check-${checkType}-icon`);
            const statusElement = document.getElementById(`check-${checkType}-status`);
            
            checkElement.className = `check-item p-4 rounded-lg border check-${status}`;
            iconElement.textContent = icon;
            statusElement.textContent = message;
        }

        function showOverallResult() {
            const totalChecks = Object.keys(validationResults).length;
            const passedChecks = Object.values(validationResults).filter(r => r.success).length;
            const failedChecks = totalChecks - passedChecks;
            
            const overallResult = document.getElementById('overallResult');
            const overallIcon = document.getElementById('overallIcon');
            const overallTitle = document.getElementById('overallTitle');
            const overallDesc = document.getElementById('overallDesc');
            const overallActions = document.getElementById('overallActions');
            
            if (failedChecks === 0) {
                overallResult.className = 'mt-8 p-6 rounded-lg border-2 border-green-500 bg-green-50';
                overallIcon.textContent = 'ğŸ‰';
                overallTitle.textContent = 'ğŸš€ MVPç³»ç»Ÿå‡†å¤‡å°±ç»ªï¼';
                overallDesc.textContent = 'æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œä½ çš„N8Näº‘ç«¯è‡ªåŠ¨å‘å¸ƒç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨äº†ï¼';
            } else if (passedChecks >= 3) {
                overallResult.className = 'mt-8 p-6 rounded-lg border-2 border-yellow-500 bg-yellow-50';
                overallIcon.textContent = 'âš ï¸';
                overallTitle.textContent = 'åŸºæœ¬åŠŸèƒ½å¯ç”¨';
                overallDesc.textContent = `${passedChecks}é¡¹é€šè¿‡ï¼Œ${failedChecks}é¡¹éœ€è¦æ³¨æ„ã€‚å¯ä»¥å¼€å§‹åŸºæœ¬ä½¿ç”¨ï¼Œå»ºè®®ç¨åä¿®å¤é—®é¢˜ã€‚`;
            } else {
                overallResult.className = 'mt-8 p-6 rounded-lg border-2 border-red-500 bg-red-50';
                overallIcon.textContent = 'âŒ';
                overallTitle.textContent = 'éœ€è¦ä¿®å¤é—®é¢˜';
                overallDesc.textContent = `${failedChecks}é¡¹æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤ä¸»è¦é—®é¢˜åå†è¯•ã€‚`;
            }
            
            overallActions.classList.remove('hidden');
        }

        function testPublish() {
            if (config.webhookUrl) {
                window.open('content-publisher-form-env.html', '_blank');
            } else {
                alert('è¯·å…ˆåŠ è½½é…ç½®');
            }
        }

        function downloadReport() {
            const report = {
                timestamp: new Date().toISOString(),
                config: config,
                summary: {
                    total: Object.keys(validationResults).length,
                    passed: Object.values(validationResults).filter(r => r.success).length,
                    failed: Object.values(validationResults).filter(r => !r.success).length
                },
                details: validationResults,
                recommendations: [
                    'ç¡®ä¿N8Näº‘ç«¯å®ä¾‹æ­£å¸¸è¿è¡Œ',
                    'éªŒè¯GitHubä»“åº“æƒé™è®¾ç½®',
                    'æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™',
                    'å¦‚æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯'
                ]
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `n8n-cloud-validation-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>