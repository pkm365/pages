<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交互式项目绩效评估可视化 (V4 - 贡献度模型)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; scroll-behavior: smooth; }
        .section-card { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%; }
        .slider-thumb::-moz-range-thumb { width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%; }
        .pie-chart-container { position: relative; width: 100%; padding-top: 100%; }
        .pie-chart { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background-image: conic-gradient(from 0deg, var(--gradient-values)); transition: all 0.5s ease-in-out; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .input-field { border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; border-radius: 0.375rem; width: 100%; transition: border-color 0.2s; }
        .input-field:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">项目绩效评估可视化模型</h1>
            <p class="mt-4 text-lg text-gray-600">基于内部“贡献度”的价值衡量模型</p>
        </header>

        <!-- 第一阶段 -->
        <section id="stage1" class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8">第一阶段：计算“绩效蛋糕”的真实价值</h2>
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <div class="p-6 rounded-2xl shadow-lg section-card space-y-4">
                    <h3 class="text-xl font-semibold">核心价值指标</h3>
                    <div>
                        <label for="contributionValue" class="font-medium">贡献值金额 (元)</label>
                        <input type="number" id="contributionValue" value="400000" class="input-field">
                    </div>
                    <div>
                        <label for="plannedHours" class="font-medium">计划工时 (人天): <span id="plannedHoursValue" class="font-bold text-blue-600">200</span></label>
                        <input type="range" id="plannedHours" min="1" max="500" value="200" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    </div>
                     <div class="p-3 bg-blue-50 rounded-lg">
                        <label class="font-medium text-sm text-gray-600">自动计算的单位人天贡献值:</label>
                        <div id="derivedManDayValue" class="text-2xl font-bold text-blue-600"></div>
                    </div>
                </div>

                <div class="p-6 rounded-2xl shadow-lg section-card text-center">
                    <h3 class="text-xl font-semibold mb-2">项目绩效池分析</h3>
                    <p class="text-gray-600">实际总投入: <span id="totalActualHours" class="font-bold text-xl"></span> 人天</p>
                    <div id="valueAnalysis" class="mt-4 space-y-2">
                        <!-- Value analysis details will be injected here -->
                    </div>
                    <div class="relative w-40 h-40 mx-auto mt-4">
                        <svg id="cakeSvg" viewBox="0 0 100 100" class="w-full h-full transition-transform duration-500"></svg>
                    </div>
                </div>
            </div>
        </section>

        <!-- 第二阶段 -->
        <section id="stage2" class="mb-16">
             <h2 class="text-3xl font-bold text-center mb-8">第二阶段：如何公平地切分“蛋糕”？</h2>
            <div class="grid lg:grid-cols-3 gap-8">
                <div id="memberControls" class="lg:col-span-2 grid md:grid-cols-2 gap-6">
                    <!-- Member cards will be injected here -->
                </div>
                <div class="p-6 rounded-2xl shadow-lg section-card lg:col-span-1">
                    <h3 class="text-xl font-semibold mb-4 text-center">实时绩效分配</h3>
                    <div class="pie-chart-container mx-auto max-w-[300px]">
                        <div id="pieChart" class="pie-chart"></div>
                    </div>
                    <div id="pieLegend" class="mt-6 space-y-2 text-sm">
                        <!-- Legend items will be injected here -->
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        const team = [
            { id: 0, name: '张三 (技术攻坚)', hours: 60, quality: 1.2, role: 1.3, teamwork: 1.1, color: '#34d399' },
            { id: 1, name: '李四 (项目管理)', hours: 50, quality: 1.1, role: 1.2, teamwork: 1.2, color: '#60a5fa' },
            { id: 2, name: '王五 (主力开发)', hours: 70, quality: 1.0, role: 1.0, teamwork: 1.0, color: '#facc15' },
            { id: 3, name: '赵六 (测试)', hours: 30, quality: 1.1, role: 0.9, teamwork: 1.1, color: '#f87171' },
            { id: 4, name: '孙七 (初级开发)', hours: 40, quality: 0.9, role: 0.9, teamwork: 0.9, color: '#c084fc' },
        ];

        const D = { // DOM elements
            contributionValue: document.getElementById('contributionValue'),
            plannedHours: document.getElementById('plannedHours'),
            plannedHoursValue: document.getElementById('plannedHoursValue'),
            derivedManDayValue: document.getElementById('derivedManDayValue'),
            totalActualHours: document.getElementById('totalActualHours'),
            valueAnalysis: document.getElementById('valueAnalysis'),
            cakeSvg: document.getElementById('cakeSvg'),
            memberControls: document.getElementById('memberControls'),
            pieChart: document.getElementById('pieChart'),
            pieLegend: document.getElementById('pieLegend')
        };

        function formatCurrency(num) {
            return new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(num);
        }

        function createMemberControls() {
            let html = '';
            team.forEach(m => {
                html += `
                    <div class="p-4 rounded-xl shadow-md section-card border-l-4" style="border-color: ${m.color};">
                        <h4 class="font-bold text-lg">${m.name}</h4>
                        <div class="space-y-3 text-sm mt-3">
                            <div>
                                <label for="hours-${m.id}">投入工时(人天): <span id="hours-val-${m.id}" class="font-semibold">${m.hours}</span></label>
                                <input type="range" id="hours-${m.id}" data-id="${m.id}" data-prop="hours" min="0" max="150" value="${m.hours}" step="1" class="w-full h-1.5 bg-gray-200 rounded-lg slider-thumb">
                            </div>
                            <div>
                                <label for="quality-${m.id}">产出质量: <span id="quality-val-${m.id}" class="font-semibold">${m.quality.toFixed(1)}</span></label>
                                <input type="range" id="quality-${m.id}" data-id="${m.id}" data-prop="quality" min="0.7" max="1.5" value="${m.quality}" step="0.1" class="w-full h-1.5 bg-gray-200 rounded-lg slider-thumb">
                            </div>
                            <div>
                                <label for="role-${m.id}">角色难度: <span id="role-val-${m.id}" class="font-semibold">${m.role.toFixed(1)}</span></label>
                                <input type="range" id="role-${m.id}" data-id="${m.id}" data-prop="role" min="0.7" max="1.5" value="${m.role}" step="0.1" class="w-full h-1.5 bg-gray-200 rounded-lg slider-thumb">
                            </div>
                            <div>
                                <label for="teamwork-${m.id}">协同管理: <span id="teamwork-val-${m.id}" class="font-semibold">${m.teamwork.toFixed(1)}</span></label>
                                <input type="range" id="teamwork-${m.id}" data-id="${m.id}" data-prop="teamwork" min="0.7" max="1.5" value="${m.teamwork}" step="0.1" class="w-full h-1.5 bg-gray-200 rounded-lg slider-thumb">
                            </div>
                        </div>
                    </div>`;
            });
            D.memberControls.innerHTML = html;
        }

        function updateAll() {
            const contributionValue = parseFloat(D.contributionValue.value) || 0;
            const plannedHours = parseInt(D.plannedHours.value);
            const totalActualHours = team.reduce((sum, m) => sum + m.hours, 0);

            D.totalActualHours.textContent = totalActualHours;
            D.plannedHoursValue.textContent = plannedHours;

            const derivedManDayValue = plannedHours > 0 ? contributionValue / plannedHours : 0;
            D.derivedManDayValue.textContent = formatCurrency(derivedManDayValue);
            
            const hourDifference = totalActualHours - plannedHours;
            const valueDifference = hourDifference * derivedManDayValue;
            const adjustedPool = contributionValue - valueDifference;
            
            updateCakeVisual(contributionValue, adjustedPool, valueDifference);
            updateDistribution(totalActualHours, adjustedPool);
        }

        function updateCakeVisual(initialValue, finalPool, valueDiff) {
            const ratio = initialValue > 0 ? finalPool / initialValue : 0;
            const scale = Math.max(ratio, 0);
            
            let color = '#ef4444'; // Red for overrun
            let analysisHtml = `
                <div class="text-sm">贡献值总额: <strong class="text-green-600">${formatCurrency(initialValue)}</strong></div>
                <div class="text-sm">工时超用消耗: <strong class="text-red-600">${formatCurrency(valueDiff)}</strong></div>
                <div class="font-bold mt-2">修正后绩效池: <strong class="text-xl text-blue-600">${formatCurrency(finalPool)}</strong></div>`;

            if (valueDiff <= 0) {
                color = '#22c55e'; // Green for on-budget or under
                 analysisHtml = `
                    <div class="text-sm">贡献值总额: <strong class="text-green-600">${formatCurrency(initialValue)}</strong></div>
                    <div class="text-sm">工时节约增值: <strong class="text-green-600">${formatCurrency(valueDiff * -1)}</strong></div>
                    <div class="font-bold mt-2">修正后绩效池: <strong class="text-xl text-blue-600">${formatCurrency(finalPool)}</strong></div>`;
            }

            D.valueAnalysis.innerHTML = analysisHtml;
            D.cakeSvg.innerHTML = `<path d="M 50,5 A 45,45 0 1 1 49.9,5 Z" fill="${color}" />`;
            D.cakeSvg.style.transform = `scale(${scale})`;
        }
        
        function updateDistribution(totalHours, pool) {
             if (totalHours === 0) {
                updatePieChart([], 0);
                return;
            }
            
            const memberScores = team.map(m => {
                const modifier = m.quality * m.role * m.teamwork;
                const baselineShare = m.hours / totalHours;
                const score = baselineShare * modifier;
                return { ...m, score };
            });

            const totalScore = memberScores.reduce((sum, m) => sum + m.score, 0);

            const finalDistribution = memberScores.map(m => ({
                ...m,
                finalShare: totalScore > 0 ? (m.score / totalScore) : 0
            }));

            updatePieChart(finalDistribution, pool);
        }


        function updatePieChart(distribution, pool) {
            let gradientString = 'lightgray 0deg, lightgray 360deg';
            let legendHtml = '';

            if(distribution.length > 0 && distribution.some(m => m.finalShare > 0)) {
                gradientString = '';
                let currentAngle = 0;
                distribution.forEach(m => {
                    const percentage = m.finalShare * 100;
                    if (percentage > 0) {
                        gradientString += `${m.color} ${currentAngle}deg, ${m.color} ${currentAngle + percentage * 3.6}deg, `;
                    }
                    currentAngle += percentage * 3.6;

                    const memberValue = Math.max(0, pool) * m.finalShare;
                    legendHtml += `
                        <div class="flex items-center justify-between">
                           <div>
                                <span class="legend-dot" style="background-color: ${m.color};"></span>
                                <span>${m.name}</span>
                           </div>
                           <strong class="text-right">${formatCurrency(memberValue)}</strong>
                        </div>
                    `;
                });
                gradientString = gradientString.slice(0, -2);
            }
            
            D.pieChart.style.setProperty('--gradient-values', gradientString);
            D.pieLegend.innerHTML = legendHtml;
        }

        function addEventListeners() {
            D.contributionValue.addEventListener('input', updateAll);
            D.plannedHours.addEventListener('input', updateAll);
            D.memberControls.addEventListener('input', (e) => {
                if(e.target.type === 'range') {
                    const id = e.target.dataset.id;
                    const prop = e.target.dataset.prop;
                    const value = parseFloat(e.target.value);
                    team[id][prop] = value;
                    document.getElementById(`${prop}-val-${id}`).textContent = prop === 'hours' ? value : value.toFixed(1);
                    updateAll();
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            createMemberControls();
            addEventListeners();
            // Set initial values based on the example
            D.contributionValue.value = 400000;
            D.plannedHours.value = 200;
            const initialTeamHours = team.reduce((acc, m) => acc + m.hours, 0);
            team.forEach(m => { m.hours = Math.round((m.hours / initialTeamHours) * 250) });
            // Re-create controls with new hours
            createMemberControls();
            updateAll();
        });
    </script>
</body>
</html>